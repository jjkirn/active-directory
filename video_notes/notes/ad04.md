# [TEARING DOWN the DOMAIN CONTROLLER (Active Directory #04)](https://www.youtube.com/watch?v=B8o6zEngpjk)
In this video John fixed the errors produced by "random_domain.ps1" script related to security policy issues he encountered in the previous video.

#### <b>REMINDER:</b> If you download the "random_domain.ps1" script from [John's github](https://github.com/JohnHammond/active_directory/blob/main/code/random_domain.ps1) or my repo - all is now fixed.  Our assumption is that we are using this "fixed" version going forward.

Steps to be taken in this section:
1. We will be using the "random_domain.ps1" script on **MGT** to produce a file (out.json) that contains randomly generated users, groups, and localadmins.
2. We will transfer the (out.json) file to **DC1** where we run the "gen_ad.ps1" script and supply the file (out.json) as input. The script will take the randomly generated data and add it to the Active Directory (AD) data on **DC1**.
3. We will also show how to "tear down" the AD configuration by using "gen_ad.ps1" together with our (out.json) file and the undo flag (-Undo) to remove all the new data from our AD.
---
Using **MGT**, Login as "local_admin", open terminal as administrator. Move to the "active-directory\code" directory:
```
PS C:\Users\local_admin> cd .\active-directory\code\
PS C:\Users\local_admin> ls
    Directory: C:\Users\local_admin\active-directory\code


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         8/26/2024   5:26 PM                data
-a----         8/26/2024   5:26 PM            753 ad_schema.json
-a----         8/26/2024   5:26 PM           3779 gen_ad.ps1
-a----         8/26/2024   5:26 PM           2120 random_domain.ps1
```
Run the "random_domain.ps1" script without any parmeters:
```
PS C:\Users\local_admin\active-directory\code> .\random_domain.ps1
```
It will prompt you for "OutputJSONFile" - use "out.json"
```
cmdlet random_domain.ps1 at command pipeline position 1
Supply values for the following parameters:
OutputJSONFile:
```
You should now have a "out.json" file created. [Below is an example]

Cat it out:
```
PS C:\Users\local_admin\active-directory\code> cat out.json
{
    "domain":  "xyz.com",
    "users":  [
                  {
                      "groups":  "Developers",
                      "name":  "Emma Short",
                      "password":  "sweetie"
                  },
                  {
                      "groups":  "Developers",
                      "name":  "Richard Lewis",
                      "password":  "banana"
                  },
                  {
                      "groups":  "Developers",
                      "name":  "Tim Newman",
                      "password":  "heaven"
                  },
                  {
                      "groups":  "Developers",
                      "name":  "Adrian Jones",
                      "password":  "roberto"
                  },
                  {
                      "groups":  "Developers",
                      "name":  "Dylan Tucker",
                      "password":  "hellokitty"
                  }
              ],
    "groups":  [
                   {
                       "name":  "Developers"
                   }
               ]
}
```
Your output will be different as this is randomly generated.


We need to transfer this file to **DC1** to add the configuration to our Active Directory (AD) data. 

Create new session to **DC1**:
```
PS C:\Users\local_admin\active_directory\code> $dc = New-PSSession 192.168.175.155 -Credential (Get-Credential)
```
We can now copy the file (out.json) from **MGT** to **DC1** via:
```
PS C:\Users\local_admin\active_directory\code> Copy-Item .\out.json -ToSession $dc C:\Windows\Tasks
```

Enter session to be on DC1:
```
PS C:\Users\local_admin\active_directory\code> Enter-PSSession $dc
```
---
Now in a session to DC1:
```
[192.168.175.155] PS c:\Users\Administrator\Documents>
```
Move to Tasks directory:
```
[192.168.175.155] PS c:\Users\Administrator\Documents> cd C:\Windows\Tasks
[192.168.175.155] PS C:\Windows\Tasks>
```
We should now have our newly generated "out.json" file here:
```
[192.168.175.155]: PS C:\Windows\Tasks> ls


    Directory: C:\Windows\Tasks


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         8/26/2024   5:26 PM            753 ad_schema.json
-a----         8/26/2024   4:35 PM           3779 gen_ad.ps1
-a----         8/28/2024   8:27 PM           2234 out.json
-a----         8/28/2024  10:44 AM          17204 secpol.cfg
```

We can now add the random users based the "out.json" file contents to our Active Directory data by running the "gen_ad.ps1" script with our "out.json" file as input:
```
[192.168.175.155] PS C:\Windows\Tasks> .\gen_ad.ps1 .\out.json
```
The script should run without any errors!

You should now have a "bunch" of new random users, groups, passwords on **DC1** Active Directory.

---
Power on **WS1**:
- Try to login as one of the random users we just created on **DC1**
- It worked !!!
- Open PowerShell terminal:
```
PS C:\Users\abrown>
PS C:\Users\abrown> net user /domain
```
- You should see a long list of all the users the script created !!!
- Power off **WS1***
---
This is where we use the -Undo option to remove all our previous users.

Switch to **MGT** and in session to **DC1**.

Run the below to remove all users:
```
[192.168.175.155] PS C:\Windows\Tasks> .\gen_ad.ps1 .\out.json -Undo
```
Verify all the users that we created are now all gone:
```
[192.168.175.155] PS C:\Windows\Tasks> net user /domain
```
Should only see:
```
Administrator Guest krbtgt
```
Verify the created groups are gone:
```
[192.168.175.155] PS C:\Windows\Tasks> net group /domain
```
### It works !!!
---
END OF THIS VIDEO !
